name: Gated Secure Pipeline

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ 'main' ]

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: read

jobs:
  # --- 1. BUILD & TEST (Standard) ---
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Build Dummy
        run: echo "Building..."

  # --- 2. SECURITY GATE ---
  SecurityGate:
    runs-on: ubuntu-latest
    needs: Build
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Zip Source Code
        run: zip -r source_code.zip . -x ".git/*"

      # 1. Trigger Scan
      - name: Trigger Security Scan
        id: trigger_scan
        run: |
          echo "ğŸš€ Uploading source code to AI Agent..."
          RESPONSE=$(curl -s -X POST ${{ secrets.AI_URL }}/scan/upload \
            -H "X-API-Key: ${{ secrets.AI_API_KEY }}" \
            -F "project=${{ github.repository }}" \
            -F "branch=${{ github.ref_name }}" \
            -F "commit_sha=${{ github.sha }}" \
            -F "ci_provider=GitHub-Actions" \
            -F "repo_url=${{ github.server_url }}/${{ github.repository }}" \
            -F "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -F "file=@source_code.zip")
          
          echo "Response: $RESPONSE"
          SCAN_ID=$(echo $RESPONSE | jq -r '.scan_id')
          echo "scan_id=$SCAN_ID" >> $GITHUB_OUTPUT
          echo "Scan ID: $SCAN_ID"

      # 2. Poll for Completion
      - name: Wait for Scan Completion
        run: |
          SCAN_ID=${{ steps.trigger_scan.outputs.scan_id }}
          STATUS="pending"
          LAST_STATUS=""
          echo "â³ Polling status for Scan ID: $SCAN_ID..."

          while true; do
            RESPONSE=$(curl -s -X GET ${{ secrets.AI_URL }}/scan_status/$SCAN_ID \
              -H "X-API-Key: ${{ secrets.AI_API_KEY }}")
            
            NEW_STATUS=$(echo $RESPONSE | jq -r '.status')
            
            if [[ -n "$NEW_STATUS" && "$NEW_STATUS" != "null" ]]; then
              STATUS="$NEW_STATUS"
            fi

            if [[ "$STATUS" != "$LAST_STATUS" ]]; then
              echo "Current Status: $STATUS"
              LAST_STATUS="$STATUS"
            fi

            if [[ "$STATUS" == "completed" || "$STATUS" == "failed" || "$STATUS" == "timeout" ]]; then
              break
            fi

            sleep 10
          done

          if [[ "$STATUS" != "completed" ]]; then
            echo "âŒ Scan Timed Out or Failed!"
            exit 1
          fi

          # 3. Check for Blocking Issues (Optional)
          # We can check risk_score or critical_count from the same response
          RISK_SCORE=$(echo $RESPONSE | jq -r '.risk_score')
          echo "Final Risk Score: $RISK_SCORE"
          
          # Example: Fail if risk > 8.0
          # if (( $(echo "$RISK_SCORE > 8.0" | bc -l) )); then
          #   echo "âŒ Security Gate Failed: Risk Score too high!"
          #   exit 1
          # fi

          echo "âœ… Security Gate Passed."

  # --- 3. DEPLOY (Only runs if Gate Passes) ---
  Deploy:
    needs: SecurityGate
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push'
    steps:
      - name: Deploy Application
        run: echo "ğŸš€ Deploying to Production..."

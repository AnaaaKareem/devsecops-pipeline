pipeline {
    agent any
    stages {
        stage('AI Feed (Fast Scans)') {
            steps {
                script {
                    sh """
                        if [ -f "start.sh" ]; then
                            chmod +x start.sh
                            ./start.sh > app.log 2>&1 &
                            echo "Waiting for app to launch..."
                            sleep 15
                        else
                            echo "âš ï¸ No start.sh."
                        fi
                    """
                }
                parallel(
                    "SAST": { sh "docker run --rm -v ${WORKSPACE}:/src returntocorp/semgrep semgrep scan --config=p/default --config=p/owasp-top-ten --config=p/secrets --sarif --quiet -o semgrep.sarif || true" },
                    "Secrets": { sh "docker run --rm -v ${WORKSPACE}:/path zricethezav/gitleaks:latest detect --source='/path' --report-path='/path/gitleaks.json' --no-banner --exit-code=0 || true" },
                    "IaC": { sh "docker run --rm -v ${WORKSPACE}:/tf bridgecrew/checkov:latest -d /tf --output sarif --quiet --no-guide --soft-fail > checkov.sarif || true" },
                    "SCA": { sh "docker run --rm -v ${WORKSPACE}:/root/ aquasecurity/trivy:latest fs /root/ --format sarif --output trivy.sarif --scanners vul,config,secret || true" },
                    "DAST": { sh "docker run --rm -v ${WORKSPACE}:/zap/wrk/:/zap/wrk/ --network=host -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py -t http://localhost:80 -J z.json || true" }
                )
                // Scans done, proceeding to Audit and Deploy
            }
        }
        stage('Background Quality Audit') {
            steps {
                sh "docker run --rm -v ${WORKSPACE}:/usr/src sonarsource/sonar-scanner-cli"
            }
        }
        
        stage('Production Deployment') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "ðŸš€ AI Agent: Security Gates passed. Deploying..."
                    // Add deployment steps here
                    // sh "./deploy.sh"
                }
            }
        }
    }
}
